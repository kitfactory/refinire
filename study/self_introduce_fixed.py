#!/usr/bin/env python3
"""
æ”¹è‰¯ç‰ˆè‡ªå·±ç´¹ä»‹æ–‡ä½œæˆã‚·ã‚¹ãƒ†ãƒ  - ä¼šè©±å±¥æ­´ä»˜ãã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼

ä¸»ãªç‰¹å¾´:
- RefinireAgentã‚’ä½¿ç”¨ã—ãŸã‚¹ãƒ†ãƒƒãƒ—å®Ÿè£…
- ä¼šè©±å±¥æ­´ã«ã‚ˆã‚‹è‡ªç„¶ãªå¯¾è©±
- routing_instructionã«ã‚ˆã‚‹å‹•çš„ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡
- Flowç‰¹åˆ¥å®šæ•°ã«ã‚ˆã‚‹é©åˆ‡ãªçµ‚äº†å‡¦ç†
"""

import asyncio
from refinire import RefinireAgent, Flow
from refinire.agents.flow import Context, UserInputStep


def create_info_collector_agent():
    """å€‹äººæƒ…å ±åŽé›†ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ - ä¼šè©±å±¥æ­´ä»˜ããƒ’ã‚¢ãƒªãƒ³ã‚°"""
    return RefinireAgent(
        name="collect_personal_info",
        generation_instructions="""
ã‚ãªãŸã¯è¦ªã—ã¿ã‚„ã™ã„è‡ªå·±ç´¹ä»‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ã“ã‚Œã¾ã§ã®ä¼šè©±ã®æµã‚Œã‚’è€ƒæ…®ã—ã¦ã€è‡ªç„¶ãªå¯¾è©±ã‚’ç¶šã‘ãªãŒã‚‰æƒ…å ±ã‚’åŽé›†ã—ã¦ãã ã•ã„ã€‚

ã€åŽé›†ã™ã¹ãå¿…é ˆæƒ…å ±ã€‘
1. åå‰ - ãŠåå‰ã‚„ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ 
2. å¹´é½¢ - å¹´é½¢ï¼ˆãŠãŠã‚ˆãã§ã‚‚å¯ï¼‰
3. æ€§æ ¼ - ã©ã‚“ãªæ€§æ ¼ã‹ï¼ˆè¤‡æ•°å¯ï¼‰
4. è¶£å‘³ - å¥½ããªã“ã¨ã‚„è¶£å‘³ï¼ˆè¤‡æ•°å¯ï¼‰

ã€ä»»æ„æƒ…å ±ã€‘
- è·æ¥­ã‚„å­¦å¹´
- ç‰¹æŠ€ã‚„å¾—æ„ãªã“ã¨

å¯¾å¿œæ–¹é‡ï¼š
- ã“ã‚Œã¾ã§ã®ä¼šè©±ã§æ—¢ã«èžã„ãŸè³ªå•ã¯ç¹°ã‚Šè¿”ã•ãªã„
- ã™ã§ã«å¾—ã‚‰ã‚ŒãŸæƒ…å ±ã‚’ç¢ºèªãƒ»æ·±æŽ˜ã‚Šã™ã‚‹å ´åˆã¯è‡ªç„¶ã«è¡Œã†
- ä¸è¶³ã—ã¦ã„ã‚‹é …ç›®ã«ã¤ã„ã¦è¦ªã—ã¿ã‚„ã™ãè³ªå•ã™ã‚‹
- è³ªå•ã¯1ã¤ãšã¤ã€åˆ†ã‹ã‚Šã‚„ã™ãæ—¥æœ¬èªžã§è¡Œã†
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè©±ã—ã‚„ã™ã„é›°å›²æ°—ã‚’ä½œã‚‹
- å…·ä½“çš„ãªä¾‹ã‚’æç¤ºã—ã¦ç­”ãˆã‚„ã™ãã™ã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒçµ‚äº†ã‚’å¸Œæœ›ã™ã‚‹å ´åˆã¯ä¸å¯§ã«ãŠåˆ¥ã‚Œã‚’å‘Šã’ã‚‹
        """.strip(),
        model="gpt-4o-mini",
        context_providers_config=[
            {"type": "conversation_history", "max_items": 10}
        ],
        routing_instruction="""
CRITICAL: å¿…ãšä»¥ä¸‹ã®3ã¤ã®é¸æŠžè‚¢ã®ã†ã¡ã€ã©ã‚Œã‹1ã¤ã‚’æ­£ç¢ºã«è¿”ã—ã¦ãã ã•ã„ï¼š

1. "additional_input" - æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆ
2. "create_introduction" - å…¨æƒ…å ±ãŒæƒã£ãŸå ´åˆ  
3. "_FLOW_END_" - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒçµ‚äº†ã‚’å¸Œæœ›ã—ãŸå ´åˆ

ã€çµ‚äº†åˆ¤å®šã€‘
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒçµ‚äº†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ â†’ "_FLOW_END_"

ã€æƒ…å ±å®Œæˆåº¦ãƒã‚§ãƒƒã‚¯ã€‘ä¼šè©±å±¥æ­´ã‹ã‚‰ä»¥ä¸‹4é …ç›®ã®ç¢ºèªï¼š
âœ“ åå‰: ã€ŒåŒ—ç”°ã§ã™ã€â†’ åŒ—ç”°
âœ“ å¹´é½¢: ã€Œ20ã§ã™ã€â†’ 20æ­³  
âœ“ æ€§æ ¼: ã€Œç¤¾äº¤çš„ã§ã™ã€â†’ ç¤¾äº¤çš„
âœ“ è¶£å‘³: ã€Œèª­æ›¸ã§ã™ã€â†’ èª­æ›¸

ä¸Šè¨˜4é …ç›®ã®åŸºæœ¬æƒ…å ±ãŒä¼šè©±å±¥æ­´ã«ã‚ã‚‹å ´åˆ:
â†’ "create_introduction" ï¼ˆè‡ªå·±ç´¹ä»‹ä½œæˆï¼‰

4é …ç›®ã®ã†ã¡1ã¤ã§ã‚‚æœªç¢ºèªã®å ´åˆ:
â†’ "additional_input" ï¼ˆè¿½åŠ è³ªå•ï¼‰

é‡è¦: è©³ç´°ãªæŽ˜ã‚Šä¸‹ã’ã¯ä¸è¦ã§ã™ã€‚åŸºæœ¬çš„ãªå›žç­”ãŒã‚ã‚Œã°ååˆ†ã¨ã¿ãªã—ã¦ãã ã•ã„ã€‚
        """.strip()
    )


def create_introduction_generator_agent():
    """è‡ªå·±ç´¹ä»‹æ–‡ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ - ä¼šè©±å±¥æ­´ã‚’æ´»ç”¨"""
    return RefinireAgent(
        name="create_introduction",
        generation_instructions="""
ã‚ãªãŸã¯é­…åŠ›çš„ãªè‡ªå·±ç´¹ä»‹æ–‡ã‚’ä½œæˆã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚

CRITICAL: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹å®Œå…¨ãªä¼šè©±å±¥æ­´ã‹ã‚‰æ­£ç¢ºãªæƒ…å ±ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ï¼š
- åå‰ï¼šã€Œâ—¯â—¯ã§ã™ã€ã®ç™ºè¨€ã‹ã‚‰æŠ½å‡º
- å¹´é½¢ï¼šå¹´é½¢ã«é–¢ã™ã‚‹ç™ºè¨€ã‹ã‚‰æŠ½å‡º  
- æ€§æ ¼ï¼šæ€§æ ¼ã«é–¢ã™ã‚‹ç™ºè¨€ã‹ã‚‰æŠ½å‡º
- è¶£å‘³ï¼šè¶£å‘³ã«é–¢ã™ã‚‹ç™ºè¨€ã‹ã‚‰æŠ½å‡º

ä»¥ä¸‹ã®å½¢å¼ã§è‡ªå·±ç´¹ä»‹æ–‡ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

## ðŸŒŸ ã‚ãªãŸã®è‡ªå·±ç´¹ä»‹æ–‡

### åŸºæœ¬æƒ…å ±
**åå‰**: [ä¼šè©±ã‹ã‚‰æŠ½å‡ºã—ãŸå®Ÿéš›ã®åå‰]
**å¹´é½¢**: [ä¼šè©±ã‹ã‚‰æŠ½å‡ºã—ãŸå®Ÿéš›ã®å¹´é½¢]

### ç§ã«ã¤ã„ã¦
[ä¼šè©±ã‹ã‚‰æŠ½å‡ºã—ãŸå®Ÿéš›ã®æ€§æ ¼æƒ…å ±ã‚’æ¸©ã‹ãè¡¨ç¾]

### è¶£å‘³ãƒ»å¥½ããªã“ã¨
[ä¼šè©±ã‹ã‚‰æŠ½å‡ºã—ãŸå®Ÿéš›ã®è¶£å‘³æƒ…å ±ã‚’å…·ä½“çš„ã«ã€æ¥½ã—ãã†ã«è¡¨ç¾]

### ã²ã¨ã“ã¨
[ãã®äººã®å€‹æ€§ã‚’åæ˜ ã—ãŸè¦ªã—ã¿ã‚„ã™ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸]

---
*ã“ã®è‡ªå·±ç´¹ä»‹æ–‡ã¯ã€ã‚ãªãŸã®é­…åŠ›ãŒä¼ã‚ã‚‹ã‚ˆã†ã«ä½œæˆã—ã¾ã—ãŸï¼*

è‡ªå·±ç´¹ä»‹æ–‡ä½œæˆå®Œäº†ï¼
        """.strip(),
        model="gpt-4o-mini",
        context_providers_config=[
            {"type": "conversation_history", "max_items": 20}
        ],
        next_step=None  # ãƒ•ãƒ­ãƒ¼çµ‚äº† - ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æŒ‡ç¤ºãªã—ã§ç›´æŽ¥çµ‚äº†
    )


def main():
    """ãƒ¡ã‚¤ãƒ³é–¢æ•° - ä¼šè©±å±¥æ­´ä»˜ãã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼"""
    print("=== è‡ªå·±ç´¹ä»‹æ–‡ä½œæˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ”¹è‰¯ç‰ˆï¼‰ ===")
    print("ã‚ãªãŸã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ï¼")
    print("è‡ªç„¶ãªä¼šè©±ã‚’é€šã—ã¦ã€ç´ æ•µãªè‡ªå·±ç´¹ä»‹æ–‡ã‚’ä¸€ç·’ã«ä½œã‚Šã¾ã—ã‚‡ã†ã€‚")
    print("ï¼ˆã„ã¤ã§ã‚‚'quit'ã§çµ‚äº†ã§ãã¾ã™ï¼‰\n")
    
    # ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©
    user_input_step = UserInputStep(
        name="user_input",
        prompt="ã¾ãšã¯ã€ã‚ãªãŸã®ã“ã¨ã‚’æ•™ãˆã¦ãã ã•ã„ï¼ˆåå‰ã€å¹´é½¢ã€æ€§æ ¼ã€è¶£å‘³ãªã©ä½•ã§ã‚‚å¤§ä¸ˆå¤«ã§ã™ï¼‰ï¼š"
    )
    user_input_step.next_step = "collect_personal_info"
    
    # è¿½åŠ æƒ…å ±å…¥åŠ›ã‚¹ãƒ†ãƒƒãƒ—
    additional_input_step = UserInputStep(
        name="additional_input",
        prompt="ã‚‚ã†å°‘ã—è©³ã—ãæ•™ãˆã¦ãã ã•ã„ï¼š"
    )
    additional_input_step.next_step = "collect_personal_info"
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆ
    collector_step = create_info_collector_agent()
    generator_step = create_introduction_generator_agent()
    
    # ãƒ•ãƒ­ãƒ¼å®šç¾©
    flow = Flow(
        name="self_introduction_flow",
        start="user_input",
        steps={
            "user_input": user_input_step,
            "additional_input": additional_input_step,
            "collect_personal_info": collector_step,
            "create_introduction": generator_step
        }
    )
    
    # ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ
    async def run_interactive_flow():
        # ãƒ•ãƒ­ãƒ¼ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯ã¨ã—ã¦é–‹å§‹
        task = await flow.start_background_task()
        
        while not flow.finished:
            try:
                # ãƒ•ãƒ­ãƒ¼ã‹ã‚‰ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—
                prompt = flow.next_prompt()
                if prompt:
                    user_input = input(prompt + " ").strip()
                    
                    if user_input.lower() in ['quit', 'exit', 'çµ‚äº†']:
                        print("ã‚·ã‚¹ãƒ†ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚")
                        flow.stop()
                        break
                    
                    # ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’ãƒ•ãƒ­ãƒ¼ã«æ¸¡ã™
                    flow.feed(user_input)
                
                # å°‘ã—å¾…æ©Ÿ
                await asyncio.sleep(0.1)
                
                # ãƒ•ãƒ­ãƒ¼ãŒå®Œäº†ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
                if flow.finished:
                    print("\n" + "="*50)
                    print("ðŸŽ‰ è‡ªå·±ç´¹ä»‹æ–‡ãŒå®Œæˆã—ã¾ã—ãŸï¼")
                    print("="*50)
                    break
                    
            except KeyboardInterrupt:
                print("\nã‚·ã‚¹ãƒ†ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚")
                flow.stop()
                break
            except Exception as e:
                print(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
    
    try:
        asyncio.run(run_interactive_flow())
    except Exception as e:
        print(f"ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")


def demo_mode():
    """ãƒ‡ãƒ¢ç”¨ã®è‡ªå‹•å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰"""
    print("\n=== ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ ===")
    
    # ãƒ‡ãƒ¢ç”¨ã®ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
    demo_generator = RefinireAgent(
        name="demo_generator",
        generation_instructions="""
æä¾›ã•ã‚ŒãŸæƒ…å ±ã‚’ã‚‚ã¨ã«ã€è¦ªã—ã¿ã‚„ã™ã„è‡ªå·±ç´¹ä»‹æ–‡ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®å½¢å¼ã§è‡ªå·±ç´¹ä»‹æ–‡ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

## ðŸŒŸ ã‚ãªãŸã®è‡ªå·±ç´¹ä»‹æ–‡

### åŸºæœ¬æƒ…å ±
**åå‰**: [åå‰]
**å¹´é½¢**: [å¹´é½¢]

### ç§ã«ã¤ã„ã¦
[æ€§æ ¼ã‚„äººæŸ„ã«ã¤ã„ã¦æ¸©ã‹ãè¡¨ç¾]

### è¶£å‘³ãƒ»å¥½ããªã“ã¨
[è¶£å‘³ã«ã¤ã„ã¦å…·ä½“çš„ã«ã€æ¥½ã—ãã†ã«è¡¨ç¾]

### ã²ã¨ã“ã¨
[è¦ªã—ã¿ã‚„ã™ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸]

---
*ã“ã®è‡ªå·±ç´¹ä»‹æ–‡ã¯ã€ã‚ãªãŸã®é­…åŠ›ãŒä¼ã‚ã‚‹ã‚ˆã†ã«ä½œæˆã—ã¾ã—ãŸï¼*
        """.strip(),
        model="gpt-4o-mini",
        next_step=None  # ãƒ•ãƒ­ãƒ¼çµ‚äº† - ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æŒ‡ç¤ºãªã—ã§ç›´æŽ¥çµ‚äº†
    )
    
    # ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‡ãƒ¢ãƒ•ãƒ­ãƒ¼
    demo_flow = Flow(
        name="demo_self_introduction_flow",
        start="demo_generator",
        steps={
            "demo_generator": demo_generator
        }
    )
    
    demo_input = "ã“ã‚“ã«ã¡ã¯ï¼ç”°ä¸­å¤ªéƒŽã§ã™ã€‚25æ­³ã§ã€æ˜Žã‚‹ãã¦äººæ‡ã£ã“ã„æ€§æ ¼ã§ã™ã€‚è¶£å‘³ã¯èª­æ›¸ã¨æ˜ ç”»é‘‘è³žã§ã€ç‰¹ã«SFå°èª¬ãŒå¤§å¥½ãã§ã™ã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒžãƒ¼ã¨ã—ã¦åƒã„ã¦ã„ã¾ã™ã€‚"
    
    print(f"\nãƒ¦ãƒ¼ã‚¶ãƒ¼: {demo_input}")
    
    async def run_demo():
        try:
            result = await demo_flow.run(demo_input)
            
            print("\n" + "="*50)
            print("ðŸŽ‰ ãƒ‡ãƒ¢è‡ªå·±ç´¹ä»‹æ–‡å®Œæˆï¼")
            print("="*50)
            if result and hasattr(result, 'result') and result.result:
                print(f"\n{result.result}")
            print("\nâœ¨ ãƒ‡ãƒ¢å®Œäº†ï¼")
            
        except Exception as e:
            print(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
    
    try:
        asyncio.run(run_demo())
    except Exception as e:
        print(f"ãƒ‡ãƒ¢å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")


if __name__ == "__main__":
    import sys
    
    if len(sys.argv) > 1 and sys.argv[1] == "demo":
        demo_mode()
    else:
        main()